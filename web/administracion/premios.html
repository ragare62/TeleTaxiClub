<!DOCTYPE html>
<html>

<head>

   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">

   <title>Teletaxi Valencia - Club</title>

   <!-- Core CSS - Include with every page -->
   <link href="css/bootstrap.min.css" rel="stylesheet">
   <link href="font-awesome/css/font-awesome.css" rel="stylesheet">

   <!-- Page-Level Plugin CSS - Blank -->
   <!-- Page-Level Plugin CSS - Tables -->
   <link href="css/plugins/dataTables/dataTables.bootstrap.css" rel="stylesheet">

   <!-- SB Admin CSS - Include with every page -->
   <link href="css/sb-admin.css" rel="stylesheet">

</head>

<body>

    <div id="wrapper">

        <nav class="navbar navbar-default navbar-fixed-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".sidebar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://www.teletaxivalencia.com"><img src="img/logotele.jpg"></a>
            </div>
            <!-- /.navbar-header -->

            <ul class="nav navbar-top-links navbar-right">
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-user fa-fw"></i> <span>Nombre de Usuario</span>  <i class="fa fa-caret-down"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-user">
                        <li><a href="#"><i class="fa fa-user fa-fw"></i> Datos de usuario</a>
                        </li>
                        <li><a href="#"><i class="fa fa-gear fa-fw"></i> Preferencias</a>
                        </li>
                        <li class="divider"></li>
                        <li><a href="loginA.html"><i class="fa fa-sign-out fa-fw"></i> Salir</a>
                        </li>
                    </ul>
                    <!-- /.dropdown-user -->
                </li>
            </ul>
            <!-- /.navbar-top-links -->

            <div class="navbar-default navbar-static-side" role="navigation">
                <div class="sidebar-collapse">
                    <ul class="nav" id="side-menu">
                        <li>
                            <a href="#"><h4>ZONA ADMINISTRACION</h4></a>
                        </li>
                        <li>
                            <a href="resumen.html"><i class="fa fa-dashboard fa-fw"></i> Resumen</a>
                        </li>
                        <li>
                            <a href="miembros.html"><i class="fa fa-table fa-fw"></i> Miembros</a>
                        </li>
                        <li>
                            <a href="premios.html"><i class="fa fa-edit fa-fw"></i> Premios</a>
                        </li>
                        <li>
                            <a href="catalogoA.html"><i class="fa fa-edit fa-fw"></i> Catálogo</a>
                        </li>
                    </ul>
                    <!-- /#side-menu -->
                </div>
                <!-- /.sidebar-collapse -->
            </div>
            <!-- /.navbar-static-side -->
        </nav>

        <div id="page-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header">Premios</h1>

                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            Relación de premios en catálogo <a href="premio.html" class="btn btn-primary">Añadir</a>
                        </div>
                        <div class="panel-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered table-hover" id="dataTableMiembros">
                                    <thead>
                                        <tr>
                                            <th>Premio</th>
                                            <th class="text-right">Nro. puntos</th>
                                            <th class="text-center">Desde fecha</th>
                                            <th class="text-center">Hasta fecha</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.row (tables) -->
        </div>
        <!-- /#page-wrapper -->

    </div>
    <!-- /#wrapper -->

    <!-- Core Scripts - Include with every page -->
    <script src="js/jquery-1.10.2.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>

    <!-- Page-Level Plugin Scripts - Tables -->
    <script src="js/plugins/dataTables/jquery.dataTables.js"></script>
    <script src="js/plugins/dataTables/dataTables.bootstrap.js"></script>
    <!-- Moment formateo de fechas -->
    <script type="text/javascript" src="js/moment-with-langs.js"></script>
    <!-- SB Admin Scripts - Include with every page -->
    <script src="js/sb-admin.js"></script>
    <!-- Knockout -->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/knockout/3.1.0/knockout-min.js"></script>
    <!-- Bootbox, para secar mensajes en pantalla -->
    <script type="text/javascript" src="js/bootbox.js"></script>
    <!-- Scripts a nivel de página -->
    <script type="text/javascript">
        // declaración general de variables
        var tablaPremios;
        var dataPremios;
        function deletePremio(idPremio){
            // primero hay que sacar un mensaje de confirmación
            bootbox.dialog({
                message: "¿Seguro que desea borrar el registro con ID:" + idPremio + " ?",
                title: "Borrado de registro",
                buttons:{
                    cancelar:{
                        label:"Cancelar",
                        className: "btn-default",
                        callback: function(){
                            // no hacemos nada es una salida de cancellar
                        }
                    },
                    borrar:{
                        label:"Borrar",
                        className: "btn-danger",
                        callback: function(){
                            var data = {"idPremio": idPremio};
                            $.ajax({
                                type:"DELETE",
                                url:"http://localhost:3000/api/premios/" + idPremio,
                                dataType: "json",
                                contentType: "application/json",
                                data: JSON.stringify(data),
                                success: function(data, status){
                                    bootbox.alert("Registro eliminado", function(){
                                        // recargar la tabla para que se vea bien
                                        window.open("premios.html",'_self');
                                    });
                                },
                                error: function (xhr, textStatus, errorThrwon) {
                                    bootbox.alert("Error: " + errorThrwon);
                                }
                            });
                        }
                    }
                }
            });
        };
        function editPremio(idPremio){
            // hay que abrir la página de premio
            // pasando en la url ese ID
            var url = "premio.html?IdPremio=" + idPremio;
            window.open(url,'_self');
        };
        function loadPremios(){
            $.ajax({
                type:"GET",
                url:"http://localhost:3000/api/premios",
                dataType:"json",
                success:function(premios, textStatus){
                    dataPremios = premios;
                    loadTablaPremios();
                }
            });
        }
        function loadTablaPremios(){
            tablaPremios = $('#dataTableMiembros').dataTable({
                language: {
                            processing:     "Procesando...",
                            search:        "Buscar: ",
                            lengthMenu:    "Mostrar _MENU_ registros",
                            info:          "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                            infoEmpty:       "Mostrando registros del 0 al 0 de un total de 0 registros",
                            infoFiltered:   "(filtrado de un total de _MAX_ registros)",
                            infoPostFix:    "",
                            loadingRecords: "Cargando...",
                            zeroRecords:    "No se encontraron resultados",
                            emptyTable:    "Ningún dato disponible en esta tabla",
                            paginate: {
                                first:       "Primero",
                                previous:   "Anterior",
                                next:       "Siguiente",
                                last:       "Último"
                            },
                            aria: {
                                sortAscending:  ": Activar para ordenar la columna de manera ascendente",
                                sortDescending: ": Activar para ordenar la columna de manera descendente"
                            }
                },
                data:dataPremios,
                columns:[
                    {data: "titulo"},
                    {
                        data: "puntos",
                        class: "text-right"
                    },
                    {
                        data: "desdeFecha", 
                        render:function(data){
                            // controlamos que si la fecha es nula no se muestre
                            if (moment(data).isValid())
                                return moment(data).format('DD/MM/YYYY');
                            else
                                return "";
                        },
                        class:"text-center"
                    },
                    {
                        data: "hastaFecha",
                        render:function(data){
                            // controlamos que si la fecha es nula no se muestre
                            if (moment(data).isValid())
                                return moment(data).format('DD/MM/YYYY');
                            else
                                return "";
                        },
                        class:"text-center"
                    },
                    {
                        data: "idPremio",
                        render: function(data){
                            var bt1 = "<button class='btn btn-success' onclick='editPremio(" + data + ");'> <i class='fa fa-edit fa-fw'></i> </button>";
                            var bt2 = "<button class='btn btn-danger' onclick='deletePremio(" + data + ");'> <i class='fa fa-trash-o fa-fw'></i> </button>";
                            var html = "<div class'text-center'> "+bt1+" "+bt2+"</div>"
                            return html;
                        },
                    }                   
                ]
            });
        }
        function redrawTable(){
            window.location.reload();
        }
    </script>
    <script>
    $(document).ready(function() {
        loadPremios();
    });
    </script>

</body>

</html>
